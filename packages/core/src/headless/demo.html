<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Headless Text Formatting Demo</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      h2 {
        margin-bottom: 10px;
      }

      .toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        position: relative;
      }

      button {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: #f8f8f8;
        cursor: pointer;
        font-size: 18px;
        transition: background 0.2s;
        position: relative;
      }

      button:hover {
        background-color: #e6e6e6;
      }

      #editor {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 150px;
        white-space: pre-wrap;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      pre {
        background: #f6f6f6;
        padding: 10px;
        border-radius: 6px;
      }

      .underline {
        text-decoration: underline;
      }
      .strike {
        text-decoration: line-through;
      }

      #colorIndicator {
        width: 18px;
        height: 4px;
        background: black;
        border-radius: 2px;
        display: block;
        margin: 3px auto 0;
      }

      #resetColor {
        font-size: 14px;
        position: absolute;
        right: -10px;
        top: -6px;
        cursor: pointer;
      }

      /* âœ… Native color input always to right of button (same as main editor) */
      #fixedColorInput {
        position: absolute;
        left: calc(100% + 6px); /* just to the right */
        top: 0;
        width: 32px;
        height: 32px;
        opacity: 0; /* invisible but clickable when triggered */
        border: none;
        margin: 0;
        padding: 0;
        cursor: pointer;
        pointer-events: none; /* hidden until we manually trigger it */
      }

      /* make sure button group is stable */
      .color-wrapper {
        position: relative;
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <h2>Headless Text Editor</h2>

    <div class="toolbar">
      <button id="boldBtn"><b>B</b></button>
      <button id="italicBtn"><i>I</i></button>
      <button id="underlineBtn"><span class="underline">U</span></button>
      <button id="strikeBtn"><span class="strike">S</span></button>

      <!-- ðŸŽ¨ Color button group -->
      <div class="color-wrapper">
        <button id="colorBtn" title="Font Color">
          <span style="font-weight: bold">A</span>
          <span id="colorIndicator"></span>
          <span id="resetColor">ðŸ”„</span>
        </button>
        <input type="color" id="fixedColorInput" />
      </div>
    </div>

    <div id="editor" contenteditable="true"></div>

    <h3>HTML Output</h3>
    <pre id="output"></pre>

    <script src="./dist/headless.umd.js"></script>
    <script>
      const {
        initHeadless,
        toggleBold,
        toggleItalic,
        toggleUnderline,
        toggleStrikethrough,
        toggleFontColor,
        setActiveFontColor,
        getActiveFontColor,
        getContentHtml,
        updatePlainText,
      } = window.TextIgniterHeadless;

      const editor = document.getElementById('editor');
      const output = document.getElementById('output');
      const colorBtn = document.getElementById('colorBtn');
      const colorInput = document.getElementById('fixedColorInput');
      const colorIndicator = document.getElementById('colorIndicator');
      const resetColor = document.getElementById('resetColor');

      initHeadless('');

      function renderFromModel() {
        const html = getContentHtml();
        editor.innerHTML = html;
        output.innerText = html;
      }

      function updateIndicator() {
        colorIndicator.style.background = getActiveFontColor();
      }
      updateIndicator();

      editor.addEventListener('input', () => {
        updatePlainText(editor.innerText);
        output.innerText = getContentHtml();
      });

      function getAbsoluteOffsets(editorEl, selection) {
        const range = selection.getRangeAt(0);
        const preRange = document.createRange();
        preRange.selectNodeContents(editorEl);
        preRange.setEnd(range.startContainer, range.startOffset);
        const start = preRange.toString().length;
        preRange.setEnd(range.endContainer, range.endOffset);
        const end = preRange.toString().length;
        return { start, end };
      }

      function handleToggle(action) {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return;
        const { start, end } = getAbsoluteOffsets(editor, selection);
        if (start === end) return;
        switch (action) {
          case 'bold':
            toggleBold(start, end);
            break;
          case 'italic':
            toggleItalic(start, end);
            break;
          case 'underline':
            toggleUnderline(start, end);
            break;
          case 'strike':
            toggleStrikethrough(start, end);
            break;
        }
        renderFromModel();
      }

      document
        .getElementById('boldBtn')
        .addEventListener('click', () => handleToggle('bold'));
      document
        .getElementById('italicBtn')
        .addEventListener('click', () => handleToggle('italic'));
      document
        .getElementById('underlineBtn')
        .addEventListener('click', () => handleToggle('underline'));
      document
        .getElementById('strikeBtn')
        .addEventListener('click', () => handleToggle('strike'));

      // ðŸŽ¨ Fixed-position native color chooser (opens to the right)
      colorBtn.addEventListener('click', () => {
        colorInput.value = getActiveFontColor();
        colorInput.style.pointerEvents = 'auto';
        colorInput.click();
        setTimeout(() => {
          colorInput.style.pointerEvents = 'none';
        }, 300);
      });

      // ðŸŽ¨ Apply color on pick
      colorInput.addEventListener('input', () => {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return;
        const { start, end } = getAbsoluteOffsets(editor, selection);
        if (start === end) return;

        const chosenColor = colorInput.value;
        setActiveFontColor(chosenColor);
        updateIndicator();
        toggleFontColor(start, end, chosenColor);
        renderFromModel();
      });

      // ðŸ”„ Reset to black
      resetColor.addEventListener('click', () => {
        setActiveFontColor('#000000');
        updateIndicator();
      });

      renderFromModel();
    </script>
  </body>
</html>
