<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Headless Text Formatting Demo</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }

      h2 {
        margin-bottom: 10px;
      }

      .toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      button {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: #f8f8f8;
        cursor: pointer;
        font-size: 18px;
        transition: background 0.2s;
      }

      button:hover {
        background-color: #e6e6e6;
      }

      #editor {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 150px;
        white-space: pre-wrap;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      pre {
        background: #f6f6f6;
        padding: 10px;
        border-radius: 6px;
      }

      /* toolbar icons for clarity */
      .underline {
        text-decoration: underline;
      }

      .strike {
        text-decoration: line-through;
      }
    </style>
  </head>
  <body>
    <h2>Headless Text Editor</h2>

    <div class="toolbar">
      <button id="boldBtn" title="Toggle Bold"><b>B</b></button>
      <button id="italicBtn" title="Toggle Italic"><i>I</i></button>
      <button id="underlineBtn" title="Toggle Underline">
        <span class="underline">U</span>
      </button>
      <button id="strikeBtn" title="Toggle Strikethrough">
        <span class="strike">S</span>
      </button>
    </div>

    <div id="editor" contenteditable="true"></div>

    <h3>HTML Output</h3>
    <pre id="output"></pre>

    <script src="./dist/headless.umd.js"></script>
    <script>
      const {
        initHeadless,
        toggleBold,
        toggleItalic,
        toggleUnderline,
        toggleStrikethrough,
        getContentHtml,
        updatePlainText,
      } = window.TextIgniterHeadless;

      const editor = document.getElementById('editor');
      const output = document.getElementById('output');
      const boldBtn = document.getElementById('boldBtn');
      const italicBtn = document.getElementById('italicBtn');
      const underlineBtn = document.getElementById('underlineBtn');
      const strikeBtn = document.getElementById('strikeBtn');

      initHeadless('');

      function renderFromModel() {
        const html = getContentHtml();
        editor.innerHTML = html;
        output.innerText = html;
      }

      editor.addEventListener('input', () => {
        updatePlainText(editor.innerText);
        output.innerText = getContentHtml();
      });

      function getAbsoluteOffsets(editorEl, selection) {
        const range = selection.getRangeAt(0);
        const preRange = document.createRange();
        preRange.selectNodeContents(editorEl);

        preRange.setEnd(range.startContainer, range.startOffset);
        const start = preRange.toString().length;

        preRange.setEnd(range.endContainer, range.endOffset);
        const end = preRange.toString().length;

        return { start, end };
      }

      function handleToggle(action) {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) return;

        const range = selection.getRangeAt(0);
        if (
          !editor.contains(range.startContainer) ||
          !editor.contains(range.endContainer)
        ) {
          alert('Select text inside editor!');
          return;
        }

        const { start, end } = getAbsoluteOffsets(editor, selection);
        if (start === end) return;

        switch (action) {
          case 'bold':
            toggleBold(start, end);
            break;
          case 'italic':
            toggleItalic(start, end);
            break;
          case 'underline':
            toggleUnderline(start, end);
            break;
          case 'strike':
            toggleStrikethrough(start, end);
            break;
        }

        renderFromModel();
        selection.removeAllRanges();
      }

      boldBtn.addEventListener('click', () => handleToggle('bold'));
      italicBtn.addEventListener('click', () => handleToggle('italic'));
      underlineBtn.addEventListener('click', () => handleToggle('underline'));
      strikeBtn.addEventListener('click', () => handleToggle('strike'));

      renderFromModel();
    </script>
  </body>
</html>
